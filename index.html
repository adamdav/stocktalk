<!DOCTYPE html>
<html class="bg-gray-200">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stocktalk</title>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/c7e73f1305.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <div class="text-gray-700 h-screen flex flex-col justify-between" id="root"></div>

    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script>
      let interval

      const render = (args = {}) => {
        const {
          query = '',
          messages = []
        } = args
        
        return ReactDOM.render(
          React.createElement(
            React.Fragment,
            null,
            React.createElement(
              'header',
              {
                className: 'bg-white p-4 shadow-lg fixed left-0 top-0 right-0 opacity-100 z-20'
              },
              React.createElement(
                'form',
                {
                  className: 'relative',
                  onSubmit: async (event) => {
                    event.preventDefault()

                    if (interval) {
                      clearInterval(interval)
                      interval = undefined
                    }

                    const queries = query.split(', ')
                    const messagesUrl = `https://v61drjipwi.execute-api.us-east-1.amazonaws.com/dev/messages?${queries.map(q => `q=${encodeURIComponent(q)}`).join('&')}`

                    try {
                      const response = await (await fetch(messagesUrl)).json()

                      const sortedMessages = response.messages
                        .slice()
                        .sort((message1, message2) => new Date(message2.created_at) - new Date(message1.created_at))

                      render({ ...args, messages: sortedMessages })
                    } catch (error) {
                      console.error(error)
                    }

                    interval = setInterval(
                      async () => {
                        try {
                          const response = await (await fetch(messagesUrl)).json()

                          const sortedMessages = response.messages
                            .slice()
                            .sort((message1, message2) => new Date(message2.created_at) - new Date(message1.created_at))
                          
                          render({ ...args, messages: sortedMessages })
                          // if (sortedMessages.first.id !== messages.first.id) {
                            
                          // }
                        } catch (error) {
                          console.error(error)
                        }
                      },
                      20000
                    )
                  }
                },
                React.createElement(
                  'i',
                  { className: 'fas fa-search absolute mt-3 ml-4' }
                ),
                React.createElement(
                  'input',
                  {
                    className: 'bg-gray-200 shadow-inner w-full pl-10 pr-4 py-2 outline-none rounded-lg',
                    id: 'search',
                    type: 'text',
                    name: 'search',
                    placeholder: 'Search stocks and cryptos',
                    value: query,
                    onChange: event => render({ ...args, query: event.target.value })
                  }
                ),
              )
            ),
              React.createElement(
                'ul',
                { className: 'mt-20 p-4' },
                messages
                  .map(message => {
                    console.log(message)
                    return React.createElement(
                      'li',
                      {
                        key: message.id,
                        className: 'shadow bg-white rounded-lg p-4 mb-6 flex flex-col relative z-10'
                      },
                      React.createElement(
                        'span',
                        { className: 'inline-flex items-center mb-2' },
                        React.createElement(
                          'img',
                          { className: 'shadow rounded-full h-8 w-8', src: message.user.avatar_url }
                        ),
                        React.createElement(
                          'b',
                          {
                            className: 'mx-1'
                          },
                          message.user.username
                        ),
                      ),
                      React.createElement(
                        'blockquote',
                        { className: 'mb-2 break-words' },
                        message.body
                      ),
                      message.created_at
                    )
                  })
              ),
            // ),
            React.createElement(
              'footer',
              {className: 'fixed left-0 right-0 bottom-0 mb-2 text-gray-500 z-0 flex justify-center items-baseline'},
              "Powered by",
              React.createElement(
                'a',
                {
                  className: 'ml-2',
                  href: 'https://stocktwits.com/'
                },
                React.createElement(
                  'img',
                  {
                    className: 'h-5',
                    src: 'stocktwits.svg',
                    alt: 'Stocktwits'
                  }
                )
              )
            )
          ),
          document.querySelector('#root')
        )
      }

      render()
    </script>
  </body>
</html>